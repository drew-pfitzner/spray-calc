<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spray Calc App</title>
    <!-- Pico.css CDN for minimal, elegant design -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <style>
        /* Responsive and Aesthetic Styling (Pico.css Dark Theme) */
        body {
            background-color: var(--background-color, #1a1a1a);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem;
        }

        article,
        button,
        input[type="text"],
        input[type="number"],
        select { /* Added select */
            border-radius: 12px;
            transition: all 0.2s;
        }

        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .chemical-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            border: 1px solid var(--border-color, #333);
        }
        
        .chemical-card h5 {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }

        .chemical-card .qty {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            color: var(--h1-color);
            margin: 0;
            padding: 0;
            color: var(--primary);
        }

        .chemical-card .qty-unit {
            font-size: 1.5rem;
            font-weight: normal;
            opacity: 0.8;
            color: var(--h1-color);
        }

        .chemical-card .info-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin: 0.5rem 0;
        }

        .chemical-card .info-row span {
            font-weight: bold;
            color: var(--primary-inverse);
            background: var(--primary);
            padding: 0 0.5rem;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
        }

        .chemical-card .footer {
            margin-top: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem 1rem;
        }

        .add-chemical-form {
            padding: 1.5rem;
        }

        .grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--secondary);
            text-align: center;
        }
        h1 { color: var(--primary); }

        .flex-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .summary-flex {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .summary-flex div {
            padding: 0.5rem 1rem;
            text-align: center;
        }

        .summary-flex div p {
            margin: 0;
            font-size: 0.8rem;
            color: var(--secondary);
        }

        .summary-flex div h6 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .summary-flex div.highlight h6 {
            font-size: 2rem;
            color: var(--primary-hover);
        }

        .summary-bottom-row {
            flex-basis: 100%;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .text-center {
            text-align: center;
        }
        
        .hidden {
            display: none;
        }
        .secondary.outline:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (min-width: 600px) {
            .summary-flex div h6 {
                font-size: 1.5rem;
            }
            .summary-flex div.highlight h6 {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <main class="container">
        <hgroup>
            <h1>Spray Batch Calculator</h1>
            <p class="text-center">Fitz Farming</p>
        </hgroup>

        <!-- Setup Card -->
        <article>
            <h2>Setup Parameters</h2>
            <form id="setup-form">
                <div class="grid">
                    <div>
                        <label for="tankSize">Tank Size (L)</label>
                        <input type="number" id="tankSize" name="tankSize" value="11000">
                    </div>
                    <div>
                        <label for="paddock">Paddock Name</label>
                        <select id="paddock" name="paddock">
                            <option value="WH1">WH1</option>
                            <option value="WH2">WH2</option>
                            <option value="Ram">Ram</option>
                            <option value="W Lane">W Lane</option>
                            <option value="E Lane">E Lane</option>
                            <option value="NSS">NSS</option>
                            <option value="SSS">SSS</option>
                            <option value="WSS">WSS</option>
                            <option value="3 22">3 22</option>
                            <option value="Heaths">Heaths</option>
                            <option value="Cottage">Cottage</option>
                            <option value="B Hill">B Hill</option>
                            <option value="Reserve">Reserve</option>
                            <option value="WPN">WPN</option>
                            <option value="WPS">WPS</option>
                            <option value="Davies E">Davies E</option>
                            <option value="Davies W">Davies W</option>
                        </select>
                    </div>
                    <div>
                        <label for="area">Total Area (Ha)</label>
                        <input type="number" id="area" name="area" value="100">
                    </div>
                    <div>
                        <label for="completedHa">Completed (Ha)</label>
                        <input type="number" id="completedHa" name="completedHa" value="2">
                    </div>
                    <div>
                        <label for="waterRate">Water Rate (L/Ha)</label>
                        <input type="number" id="waterRate" name="waterRate" value="100">
                    </div>
                </div>
            </form>
        </article>

        <!-- Summary Card -->
        <article>
            <h2>Summary</h2>
            <div class="summary-flex">
                <div>
                    <p>Tanks Required</p>
                    <h6 id="summary-tanks">0</h6>
                </div>
                <div>
                    <p>Job Area (Ha)</p>
                    <h6 id="summary-job-area">0</h6>
                </div>
                <div>
                    <p>Area per Tank (Ha)</p>
                    <h6 id="summary-area-per-tank">0</h6>
                </div>
                <div>
                    <p>Total Water (L)</p>
                    <h6 id="summary-total">0</h6>
                </div>
                <div class="summary-bottom-row">
                    <div class="highlight">
                        <p>Total L per Tank</p>
                        <h6 id="summary-l-per-tank">0</h6>
                    </div>
                    <div class="highlight">
                        <p>Water to Add (L)</p>
                        <h6 id="summary-batch">0</h6>
                    </div>
                </div>
            </div>
        </article>

        <!-- Chemicals Section -->
        <article>
            <h2>Chemicals Required (Per Tank)</h2>
            <div id="chemicals-container" class="card-container">
                <p class="text-center" style="opacity: 0.7;">Add chemicals below to see the batch mix.</p>
            </div>
        </article>

        <!-- Add New Chemical Form -->
        <article>
            <h2>Add New Chemical</h2>
            <form id="add-chemical-form" class="add-chemical-form">
                <div>
                    <label for="chemicalName">Chemical Name</label>
                    <input type="text" id="chemicalName" name="chemicalName" placeholder="e.g., Basta" required>
                </div>
                <div class="grid">
                    <div class="flex-row">
                        <input type="checkbox" id="isPesticide" name="isPesticide">
                        <label for="isPesticide">Pesticide (P)</label>
                    </div>
                    <div class="flex-row">
                        <input type="checkbox" id="isLiquid" name="isLiquid">
                        <label for="isLiquid">Liquid (L)</label>
                    </div>
                    <div class="flex-row hidden" id="shuttle-container">
                        <input type="checkbox" id="isShuttle" name="isShuttle">
                        <label for="isShuttle">Shuttle Rate (S)</label>
                    </div>
                    <div>
                        <label for="rate">Rate (L/Ha, KG/Ha, or %)</label>
                        <input type="number" id="rate" name="rate" min="0" step="any" required>
                    </div>
                </div>
                
                <button type="submit" class="contrast">Add Chemical</button>
            </form>
        </article>
    </main>

    <script>
        // UI Elements
        const setupForm = document.getElementById('setup-form');
        const chemicalsContainer = document.getElementById('chemicals-container');
        const addChemicalForm = document.getElementById('add-chemical-form');
        const summaryTanks = document.getElementById('summary-tanks');
        const summaryJobArea = document.getElementById('summary-job-area');
        const summaryAreaPerTank = document.getElementById('summary-area-per-tank');
        const summaryLPerTank = document.getElementById('summary-l-per-tank');
        const summaryTotal = document.getElementById('summary-total');
        const summaryBatch = document.getElementById('summary-batch');
        const isLiquidCheckbox = document.getElementById('isLiquid');
        const shuttleContainer = document.getElementById('shuttle-container');
        const isShuttleCheckbox = document.getElementById('isShuttle');


        let setupData = {
            tankSize: 11000,
            paddock: 'WH1', // Default value
            area: 100,
            completedHa: 2,
            waterRate: 100
        };

        let chemicals = [];

        // --- URL COMPRESSION / DECOMPRESSION LOGIC ---
        
        // Key map for setup data: FullName -> ShortCode
        const SETUP_KEYS = {
            tankSize: 'TS',
            paddock: 'P',
            area: 'A',
            completedHa: 'CH',
            waterRate: 'WR'
        };

        // Key map for chemical data: FullName -> ShortCode
        // 'quantityPerTank' is intentionally excluded as it's a calculated value
        const CHEM_KEYS = {
            chemicalName: 'N',
            isPesticide: 'PP',
            isLiquid: 'L',
            isShuttle: 'S',
            rate: 'R'
        };

        // Helper to swap the key/value pairs of an object for decompression
        const invertKeys = (obj) =>
            Object.fromEntries(Object.entries(obj).map(([key, value]) => [value, key]));
        
        const INVERTED_SETUP_KEYS = invertKeys(SETUP_KEYS);
        const INVERTED_CHEM_KEYS = invertKeys(CHEM_KEYS);


        /**
         * Compresses the input data structure for the URL.
         * 1. Renames long keys to short codes (e.g., 'tankSize' -> 'TS').
         * 2. Removes calculated values.
         * 3. Encodes booleans as 1 (true) or omits them (false).
         * @returns {string} A JSON-stringified, compressed object.
         */
        function compressData(data) {
            const compressedSetup = {};
            for (const [longKey, shortKey] of Object.entries(SETUP_KEYS)) {
                compressedSetup[shortKey] = data.setupData[longKey];
            }

            const compressedChemicals = data.chemicals.map(chem => {
                const compressedChem = {};
                for (const [longKey, shortKey] of Object.entries(CHEM_KEYS)) {
                    // Only include a boolean if it's true, saving space (e.g., no 'PP:false')
                    if (typeof chem[longKey] === 'boolean' && chem[longKey] === true) {
                        compressedChem[shortKey] = 1; // Use 1 for true to save characters
                    } else if (typeof chem[longKey] !== 'boolean') {
                        compressedChem[shortKey] = chem[longKey];
                    }
                }
                return compressedChem;
            });

            // Use short keys 'S' and 'C' for top-level objects
            return JSON.stringify({ S: compressedSetup, C: compressedChemicals });
        }

        /**
         * Decompresses the data from the URL hash.
         * @param {string} compressedJsonString The compressed JSON string from the URL.
         * @returns {object} The full, uncompressed data structure.
         */
        function decompressData(compressedJsonString) {
            const parsed = JSON.parse(compressedJsonString);
            const decompressedData = {
                setupData: {},
                chemicals: []
            };

            // Decompress Setup Data
            const compressedSetup = parsed.S || {};
            for (const [shortKey, longKey] of Object.entries(INVERTED_SETUP_KEYS)) {
                // Use the short key to pull the value, falling back to the default if not present
                decompressedData.setupData[longKey] = compressedSetup[shortKey] !== undefined
                    ? compressedSetup[shortKey]
                    : setupData[longKey]; // Fallback to initial default value
            }

            // Decompress Chemical Data
            const compressedChemicals = parsed.C || [];
            decompressedData.chemicals = compressedChemicals.map(compressedChem => {
                const chem = {};
                for (const [shortKey, longKey] of Object.entries(INVERTED_CHEM_KEYS)) {
                    if (shortKey === 'PP' || shortKey === 'L' || shortKey === 'S') {
                        // Decompress booleans (if short key is 1, it's true, otherwise false)
                        chem[longKey] = compressedChem[shortKey] === 1;
                    } else if (compressedChem[shortKey] !== undefined) {
                        chem[longKey] = compressedChem[shortKey];
                    }
                }
                return chem;
            });
            
            return decompressedData;
        }
        
        // Master function to refresh all UI and update the URL
        function updateUI() {
            calculateSummary();
            updateSummary();
            renderChemicals();
            updateUrl();
        }
        
        // Function to save data to the URL hash using compression
        function updateUrl() {
            // 1. Prepare data for encoding (excluding calculated properties like quantityPerTank)
            const dataToEncode = {
                setupData,
                chemicals: chemicals.map(c => {
                    const { quantityPerTank, ...rest } = c;
                    return rest;
                })
            };

            // 2. Compress the data structure
            const compressedData = compressData(dataToEncode);

            // 3. Use btoa (Base64) to create a compact, URL-safe string
            const encodedData = btoa(compressedData); 

            // 4. Update the hash using the short key 'd='
            window.location.hash = `d=${encodedData}`; 
        }

        // Function to load data from URL hash using decompression
        function loadData() {
            const hash = window.location.hash.substring(1); // Remove the '#'
            
            // Check for the new short key 'd='
            if (hash.startsWith('d=')) { 
                const dataParam = hash.substring(2); // Remove 'd='
                try {
                    // Use atob for Base64 decoding
                    const decompressedJson = atob(dataParam);
                    const parsedData = decompressData(decompressedJson);
                    
                    // Update global variables
                    setupData = parsedData.setupData;
                    chemicals = parsedData.chemicals;

                    // Update form values from loaded data
                    for (const key in setupData) {
                        if (setupForm.elements[key]) {
                            setupForm.elements[key].value = setupData[key];
                        }
                    }
                    console.log("Data loaded and decompressed from URL hash");
                } catch (e) {
                    console.error("Could not load or decompress data from URL hash", e);
                }
            }
        }

        // Render the chemical cards
        function renderChemicals() {
            chemicalsContainer.innerHTML = '';
            if (chemicals.length === 0) {
                 chemicalsContainer.innerHTML = '<p class="text-center" style="opacity: 0.7; grid-column: 1 / -1;">Add chemicals below to see the batch mix.</p>';
                 return;
            }

            chemicals.forEach((chem, index) => {
                const article = document.createElement('article');
                article.classList.add('chemical-card');
                article.dataset.index = index;

                // Determine QTY and unit based on chemical properties
                let qtyDisplay = '';
                let unit = '';
                if (chem.isShuttle) {
                    qtyDisplay = (chem.quantityPerTank * 0.9).toFixed(0);
                    unit = 'mm';
                } else {
                    qtyDisplay = chem.quantityPerTank.toFixed(2);
                    unit = chem.isLiquid ? 'L' : 'KG';
                }

                // Conditionally display P, L, and S
                const pSpan = chem.isPesticide ? '<span>P</span>' : '';
                const lSpan = chem.isLiquid ? '<span>L</span>' : '';
                const sSpan = chem.isShuttle ? '<span>S</span>' : '';

                article.innerHTML = `
                    <header><h5>${chem.chemicalName}</h5></header>
                    <p class="qty">${qtyDisplay} <span class="qty-unit">${unit}</span></p>
                    <div class="info-row">
                        ${pSpan}
                        ${lSpan}
                        ${sSpan}
                    </div>
                    <div style="text-align:center;">Rate: ${chem.rate} ${chem.isPesticide ? (chem.isLiquid ? 'L/Ha' : 'KG/Ha') : '%'}</div>
                    <footer class="footer">
                        <button class="secondary outline" onclick="moveChemicalUp(${index})" ${index === 0 ? 'disabled' : ''} aria-label="Move chemical up">&#9650;</button>
                        <button class="secondary outline" onclick="deleteChemical(${index})">Remove</button>
                        <button class="secondary outline" onclick="moveChemicalDown(${index})" ${index === chemicals.length - 1 ? 'disabled' : ''} aria-label="Move chemical down">&#9660;</button>
                    </footer>
                `;
                chemicalsContainer.appendChild(article);
            });
        }

        // Perform calculations and update the summary UI
        function updateSummary() {
            const summary = calculateSummary();
            summaryTanks.textContent = summary.tanks;
            summaryJobArea.textContent = summary.jobArea;
            summaryAreaPerTank.textContent = summary.areaPerTank.toFixed(1);
            summaryLPerTank.textContent = summary.litersPerTank.toFixed(0);
            summaryTotal.textContent = summary.totalWater.toFixed(0);
            summaryBatch.textContent = summary.batchWater.toFixed(0);
        }

        // Main calculation logic
        function calculateSummary() {
            // Ensure inputs are treated as numbers
            const tankSize = parseFloat(setupData.tankSize) || 0;
            const area = parseFloat(setupData.area) || 0;
            const completedHa = parseFloat(setupData.completedHa) || 0;
            const waterRate = parseFloat(setupData.waterRate) || 0;

            const jobArea = Math.max(0, area - completedHa);
            
            // Calculate the total area a full tank can cover based on the water rate.
            const fullTankArea = (tankSize / waterRate);
            
            // Calculate the number of tanks needed for the remaining job area.
            let tanks = 0;
            if (jobArea > 0 && waterRate > 0) {
                tanks = Math.ceil(jobArea / fullTankArea);
            }

            // If only a partial area remains, but less than 1 tank is needed, set tanks to 1
            if (tanks === 0 && jobArea > 0) {
                tanks = 1;
            } else if (jobArea === 0) {
                tanks = 0;
            }

            // Calculate the actual area per tank based on the number of tanks needed.
            const areaPerTank = tanks > 0 ? jobArea / tanks : 0;
            
            // Calculate the actual water volume per tank based on the new area per tank.
            const litersPerTank = areaPerTank * waterRate;

            const totalWater = jobArea * waterRate;
            
            // Calculate quantities per tank for each chemical and total liquid volume
            let totalLiquidChemicalVolume = 0;
            chemicals.forEach(chem => {
                let quantityPerTank;
                if (!chem.isPesticide) {
                    // If not a pesticide, rate is a percentage of total tank water volume
                    quantityPerTank = (chem.rate / 100) * litersPerTank;
                } else {
                    // Standard rate in L/Ha or KG/Ha
                    quantityPerTank = chem.rate * areaPerTank;
                }
                
                chem.quantityPerTank = quantityPerTank; // Store on the object for rendering

                if (chem.isLiquid) {
                    totalLiquidChemicalVolume += quantityPerTank;
                }
            });
            
            // Calculate batch water (Water only)
            let batchWater = litersPerTank - totalLiquidChemicalVolume;
            if (batchWater < 0) {
                batchWater = 0;
            }

            return {
                tanks: tanks,
                jobArea: jobArea.toFixed(1),
                areaPerTank: areaPerTank,
                litersPerTank: litersPerTank,
                totalWater: totalWater,
                batchWater: batchWater
            };
        }

        // Add a new chemical
        function addChemical(e) {
            e.preventDefault();
            const form = e.target;
            const chemicalData = {
                chemicalName: form.chemicalName.value.trim(),
                isPesticide: form.isPesticide.checked,
                isLiquid: form.isLiquid.checked,
                isShuttle: form.isShuttle.checked,
                rate: parseFloat(form.rate.value)
            };
            
            if (chemicalData.chemicalName && !isNaN(chemicalData.rate)) {
                chemicals.push(chemicalData);
                updateUI();
                form.reset();
                // Explicitly hide the shuttle container after the form is reset
                shuttleContainer.classList.add('hidden');
            }
        }

        // Delete a chemical (made global for inline use)
        window.deleteChemical = function(index) {
            chemicals.splice(index, 1);
            updateUI();
        }

        // Reorder functions (made global for inline use)
        window.moveChemicalUp = function(index) {
            if (index > 0) {
                const [movedItem] = chemicals.splice(index, 1);
                chemicals.splice(index - 1, 0, movedItem);
                updateUI();
            }
        }

        window.moveChemicalDown = function(index) {
            if (index < chemicals.length - 1) {
                const [movedItem] = chemicals.splice(index, 1);
                chemicals.splice(index + 1, 0, movedItem);
                updateUI();
            }
        }
        
        // Event listeners
        setupForm.addEventListener('input', (e) => {
            setupData[e.target.name] = e.target.value;
            updateUI();
        });
        addChemicalForm.addEventListener('submit', addChemical);

        // Conditional visibility for shuttle
        isLiquidCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                shuttleContainer.classList.remove('hidden');
            } else {
                isShuttleCheckbox.checked = false; // Uncheck shuttle if liquid is unchecked
                shuttleContainer.classList.add('hidden');
            }
        });

        // Initialize the app on window load
        window.onload = () => {
            loadData();
            updateUI();
        };

    </script>
</body>
</html>
